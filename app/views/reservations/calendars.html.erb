<!DOCTYPE html>
<html>
<head>
  <title>カレンダー - 予約管理システム</title>
  <%= csrf_meta_tags %>
  <%= csp_meta_tag %>
  
  <meta name="viewport" content="width=device-width,initial-scale=1">
  
  <!-- FullCalendar CSS -->
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/main.min.css" rel="stylesheet" />
  
  <!-- カスタムCSS - Railsのアセットパイプライン経由 -->
  <%= stylesheet_link_tag 'admin/calendar-styles', media: 'all' %>
  <%= stylesheet_link_tag 'reservation-form', media: 'all' %>
  
  <!-- FullCalendar JS -->
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>
  
  <!-- グローバル変数の設定 -->
  <script>
    window.calendarEventsUrl = '<%= calendar_events_reservations_path %>';
    window.reservationsPath = '<%= new_reservation_path %>';
    window.currentUserId = <%= current_user&.id || 'null' %>;
    window.currentUserIsAdmin = <%= (current_user&.admin? ? 'true' : 'false') %>;
    <% if @reservation_params && @reservation_params[:start_time].present? %>
      window.reservationParams = {
        start_time: '<%= @reservation_params[:start_time] %>',
        end_time: '<%= @reservation_params[:end_time] %>'
      };
    <% else %>
      window.reservationParams = null;
    <% end %>
  </script>
  
  <!-- 共通バリデーションJavaScript -->
  <%= javascript_include_tag "reservation-validation", "data-turbo-track": "reload", defer: true %>
  
  <!-- カレンダー用JavaScript -->
  <%= javascript_include_tag "reservation-calendar", "data-turbo-track": "reload", defer: true %>
</head>
<body>
  <div class="header">
    <h1>カレンダー - 予約管理システム</h1>
    <div class="header-buttons">
      <% if current_user&.admin? %>
        <span class="admin-name"><%= current_user.name.presence || "管理者さん" %></span>
      <% else %>
        <span class="admin-name"><%= current_user.name.presence || current_user.email %></span>
      <% end %>
      <%= link_to '単日スケジュールに戻る', new_reservation_path, class: 'btn' %>
    </div>
  </div>
   
  <div class="controls">
    <button class="btn" id="prev-btn">◀ 前へ</button>
    <button class="btn" id="today-btn">今日</button>
    <button class="btn" id="next-btn">次へ ▶</button>
    <input type="date" id="datePicker">
  </div>
 
  <div id="calendar"></div>
 
  <!-- 予約詳細モーダル -->
  <div id="reservationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>予約詳細</h2>
        <button class="close" id="close-modal">&times;</button>
      </div>
      <div class="modal-body" id="modalBody"></div>
    </div>
  </div>

  <!-- 予約作成モーダル -->
  <div id="createReservationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>予約作成</h2>
        <button class="close" id="close-create-modal">&times;</button>
      </div>
      <div class="modal-body" id="createModalBody">
        <% if flash[:alert] %>
          <div class="error-messages" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
            <p style="margin: 0;"><%= flash[:alert] %></p>
          </div>
        <% end %>
        
        <%= form_with model: (@reservation || Reservation.new), url: reservations_path, method: :post, local: true, id: "reservationForm" do |f| %>
          <% if @reservation && @reservation.errors.any? %>
            <div class="error-messages" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
              <h3 style="margin-top: 0;">以下のエラーが発生しました:</h3>
              <ul style="margin: 0; padding-left: 20px;">
                <% @reservation.errors.full_messages.each do |message| %>
                  <li><%= message %></li>
                <% end %>
              </ul>
            </div>
          <% end %>
          
          <%= f.hidden_field :start_time, id: "reservation_start_time" %>
          <%= f.hidden_field :end_time, id: "reservation_end_time" %>
          <%= hidden_field_tag :return_to, 'calendars' %>
          
          <div class="form-group">
            <label>予約日</label>
            <p id="reservation_date_display" style="font-size: 16px; font-weight: bold; color: #007bff; padding: 10px; background-color: #e7f3ff; border-radius: 5px; margin: 0 0 15px 0;"></p>
          </div>
          
          <div class="form-group">
            <label>開始時間</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="start_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
                <% (9..17).each do |hour| %>
                  <option value="<%= hour %>" <%= 'selected' if hour == 9 %>><%= hour %>時</option>
                <% end %>
              </select>
              <select id="start_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
                <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                  <option value="<%= minute %>" <%= 'selected' if minute == 0 %>><%= minute %>分</option>
                <% end %>
              </select>
            </div>
          </div>
          
          <div class="form-group">
            <label>終了時間</label>
            <div style="display: flex; gap: 10px; align-items: center;">
              <select id="end_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
                <% (9..18).each do |hour| %>
                  <option value="<%= hour %>" <%= 'selected' if hour == 10 %>><%= hour %>時</option>
                <% end %>
              </select>
              <select id="end_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
                <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                  <option value="<%= minute %>" <%= 'selected' if minute == 0 %>><%= minute %>分</option>
                <% end %>
              </select>
            </div>
          </div>
          
          <%= f.hidden_field :customer_name, value: (@reservation&.customer_name || current_user&.name || current_user&.email&.split('@')&.first || "") %>
          <%= f.hidden_field :customer_email, value: (@reservation&.customer_email || current_user&.email || "") %>
          <%= f.hidden_field :customer_phone, value: (@reservation&.customer_phone || "") %>
          
          <div class="form-group">
            <%= f.label :notes, "備考" %>
            <%= f.text_area :notes, rows: 3, class: "form-control", value: (@reservation&.notes || "") %>
          </div>
          
          <div class="form-actions">
            <%= f.submit "予約を確定", class: "btn btn-primary" %>
            <button type="button" class="btn btn-secondary" id="cancel-create-btn">キャンセル</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</body>
</html>
