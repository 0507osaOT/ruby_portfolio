<% content_for :head do %>
  <%= stylesheet_link_tag "admin/list-styles", "data-turbo-track": "reload" %>
<% end %>

<div class="reservation-list-container">
  <h1>予約状況</h1>
  
  <!-- 予約リスト -->
  <div class="results-container">
    <div class="results-header">
      <h2>予約一覧: <%= @reservations.total_count %>件</h2>
      <%= link_to "← 単日スケジュールに戻る", new_reservation_path, class: "btn btn-back" %>
    </div>
    
    <% if @reservations.any? %>
      <div class="reservations-grid">
        <% @reservations.each do |reservation| %>
          <div class="reservation-card">
            <div class="card-row card-row-first">
              <div class="card-item datetime-item">
                <div class="card-label">予約日時</div>
                <div class="card-value">
                  <%= reservation.start_time.strftime("%Y年%m月%d日 %H:%M") %> - <%= reservation.end_time.strftime("%H:%M") %>
                </div>
              </div>
              
              <div class="card-item status-item">
                <div class="card-label">ステータス</div>
                <div class="card-value">
                  <% 
                    status = reservation.status || 'confirmed'
                    status_text = case status
                                  when 'confirmed' then '確定'
                                  when 'pending' then '保留中'
                                  when 'cancelled' then 'キャンセル'
                                  else status
                                  end
                  %>
                  <span class="badge <%= status %>">
                    <%= status_text %>
                  </span>
                </div>
              </div>
              
              <% if reservation.notes.present? %>
                <div class="card-item notes-item">
                  <div class="card-label">備考</div>
                  <div class="card-value"><%= reservation.notes %></div>
                </div>
              <% end %>
            </div>
            
            <div class="card-actions">
              <button type="button" class="btn-edit" data-reservation-id="<%= reservation.id %>" data-start-time="<%= reservation.start_time.iso8601 %>" data-end-time="<%= reservation.end_time.iso8601 %>" data-notes="<%= j(reservation.notes.to_s) %>">修正</button>
              <button type="button" class="btn-delete" data-reservation-id="<%= reservation.id %>" data-customer-name="<%= reservation.customer_name %>" data-datetime="<%= reservation.start_time.strftime("%Y年%m月%d日 %H:%M") %>">削除</button>
            </div>
          </div>
        <% end %>
      </div>
      
      <!-- 編集モーダル -->
      <div id="editModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>予約の修正</h2>
            <button class="close" id="close-edit-modal">&times;</button>
          </div>
          <div class="modal-body">
            <%= form_with model: Reservation.new, url: reservation_path(0), method: :patch, local: true, id: "editForm", data: { turbo: false }, scope: :reservation do |f| %>
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <div class="form-group">
                <label>予約日</label>
                <p id="edit_reservation_date_display" style="font-size: 16px; font-weight: bold; color: #007bff; padding: 10px; background-color: #e7f3ff; border-radius: 5px; margin: 0 0 15px 0;"></p>
              </div>
              
              <div class="form-group">
                <label>開始時間</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <select id="edit_start_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
                    <% (9..17).each do |hour| %>
                      <option value="<%= hour %>"><%= hour %>時</option>
                    <% end %>
                  </select>
                  <select id="edit_start_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
                    <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                      <option value="<%= minute %>"><%= minute %>分</option>
                    <% end %>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <label>終了時間</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                  <select id="edit_end_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
                    <% (9..18).each do |hour| %>
                      <option value="<%= hour %>"><%= hour %>時</option>
                    <% end %>
                  </select>
                  <select id="edit_end_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
                    <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                      <option value="<%= minute %>"><%= minute %>分</option>
                    <% end %>
                  </select>
                </div>
              </div>
              
              <div class="form-group">
                <%= f.label :notes, "備考" %>
                <%= f.text_area :notes, rows: 3, class: "form-control", id: "edit_notes_input" %>
              </div>
              
              <%= f.hidden_field :start_time, id: "edit_reservation_start_time" %>
              <%= f.hidden_field :end_time, id: "edit_reservation_end_time" %>
              
              <div class="form-actions">
                <%= f.submit "更新する", class: "btn btn-primary" %>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">キャンセル</button>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      
      <!-- 削除確認モーダル -->
      <div id="deleteModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2>予約削除の確認</h2>
            <button class="close" id="close-delete-modal">&times;</button>
          </div>
          <div class="modal-body">
            <p>以下の予約を削除してもよろしいですか？</p>
            <div style="background-color: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
              <p><strong>お名前:</strong> <span id="delete-reservation-name"></span></p>
              <p><strong>予約日時:</strong> <span id="delete-reservation-datetime"></span></p>
            </div>
            <p style="color: #dc3545; font-weight: bold;">この操作は取り消せません。</p>
            <%= form_with url: reservation_path(0), method: :delete, local: true, id: "deleteForm", data: { turbo: false } do |f| %>
              <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
              <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">キャンセル</button>
                <%= f.submit "削除する", class: "btn btn-danger" %>
              </div>
            <% end %>
          </div>
        </div>
      </div>
      
      <!-- 予約一覧ページ用JavaScript -->
      <%= javascript_include_tag "reservation-index", "data-turbo-track": "reload", defer: true %>
      
      <%= paginate @reservations %>
    <% else %>
      <p class="no-results">予約がありません。</p>
    <% end %>
  </div>
</div>

