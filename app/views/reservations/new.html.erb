<div class="header">
  <h1>単日スケジュール - <%= @date.year %>年<%= @date.month %>月<%= @date.day %>日</h1>
  <div class="header-buttons">
    <% if current_user&.admin? %>
      <span class="admin-name">管理者さん</span>
      <%= link_to "👥 予約者リスト", list_admin_reservations_path, class: "btn" %>
    <% else %>
      <span class="admin-name"><%= current_user.name.presence || current_user.email %></span>
      <%= link_to "📋 予約状況", reservations_path, class: "btn" %>
    <% end %>
    <%= link_to "📅 カレンダー表示", calendars_reservations_path, class: "btn" %>
    <button class="btn btn-settings" onclick="openSettingsModal()">⚙️ 設定</button>
  </div>
</div>

<div class="date-navigation">
  <a href="<%= new_reservation_path(date: (@date - 1.day).strftime('%Y-%m-%d')) %>" class="btn">◀ 前日</a>
  <a href="<%= new_reservation_path(date: Date.today.strftime('%Y-%m-%d')) %>" class="btn">今日</a>
  <a href="<%= new_reservation_path(date: (@date + 1.day).strftime('%Y-%m-%d')) %>" class="btn">翌日 ▶</a>
  <input type="date" id="datePicker" value="<%= @date.strftime('%Y-%m-%d') %>">
</div>

<div id="status">カレンダーを読み込んでいます...</div>
<div id="calendar" data-date="<%= @date.strftime('%Y-%m-%d') %>"></div>

<!-- 予約詳細モーダル -->
<div id="reservationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>予約詳細</h2>
      <button class="close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- 予約作成モーダル -->
<div id="createReservationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>予約作成</h2>
      <button class="close" onclick="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body" id="createModalBody">
      <% if @reservation && @reservation.errors.any? %>
        <div class="error-messages" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
          <h3 style="margin-top: 0;">以下のエラーが発生しました:</h3>
          <ul style="margin: 0; padding-left: 20px;">
            <% @reservation.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <%= form_with model: (@reservation || Reservation.new), url: reservations_path, method: :post, local: true, id: "reservationForm" do |f| %>
        <%= f.hidden_field :start_time, id: "reservation_start_time" %>
        <%= f.hidden_field :end_time, id: "reservation_end_time" %>
        <%= hidden_field_tag :date, @date.strftime('%Y-%m-%d') %>
        <%= hidden_field_tag :return_to, 'new' %>
        
        <div class="form-group">
          <label>予約日</label>
          <p id="reservation_date_display" style="font-size: 16px; font-weight: bold; color: #007bff; padding: 10px; background-color: #e7f3ff; border-radius: 5px; margin: 0 0 15px 0;"><%= @date.year %>年<%= @date.month %>月<%= @date.day %>日</p>
        </div>
        
        <div class="form-group">
          <label>開始時間</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="start_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% (9..17).each do |hour| %>
                <option value="<%= hour %>" <%= 'selected' if hour == 9 %>><%= hour %>時</option>
              <% end %>
            </select>
            <select id="start_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                <option value="<%= minute %>" <%= 'selected' if minute == 0 %>><%= minute %>分</option>
              <% end %>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>終了時間</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="end_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% (9..18).each do |hour| %>
                <option value="<%= hour %>" <%= 'selected' if hour == 10 %>><%= hour %>時</option>
              <% end %>
            </select>
            <select id="end_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                <option value="<%= minute %>" <%= 'selected' if minute == 0 %>><%= minute %>分</option>
              <% end %>
            </select>
          </div>
        </div>
        
        <%= f.hidden_field :customer_name, value: (@reservation&.customer_name || current_user&.name || current_user&.email&.split('@')&.first || "") %>
        <%= f.hidden_field :customer_email, value: (@reservation&.customer_email || current_user&.email || "") %>
        <%= f.hidden_field :customer_phone, value: (@reservation&.customer_phone || "") %>
        
        <div class="form-group">
          <%= f.label :notes, "備考" %>
          <%= f.text_area :notes, rows: 3, class: "form-control", value: (@reservation&.notes || "") %>
        </div>
        
        <div class="form-actions">
          <%= f.submit "予約を確定", class: "btn btn-primary" %>
          <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">キャンセル</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- 設定モーダル -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>設定</h2>
      <button class="close" onclick="closeSettingsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="settings-content">
        <% if current_user&.admin? %>
          <%= link_to "情報変更", edit_admin_registration_path, class: "btn btn-edit" %>
        <% else %>
          <%= link_to "情報変更", edit_user_registration_path, class: "btn btn-edit" %>
        <% end %>
        <p>現在ログイン中です</p>
        <%= button_to "ログアウト", destroy_user_session_path, method: :delete, class: "btn btn-logout", form: { data: { turbo: false } } %>
      </div>
    </div>
  </div>
</div>

<%= javascript_include_tag "index-schedule", "data-turbo-track": "reload", defer: true %>

<script>
  // 現在のユーザーIDをJavaScriptに渡す
  window.currentUserId = <%= current_user&.id || 'null' %>;
  window.currentUserIsAdmin = <%= (current_user&.admin? ? 'true' : 'false') %>;
  
  <%= File.read(Rails.root.join('app/javascript/index-schedule.js')).html_safe %>
</script>

<% unless current_user&.admin? %>
  <!-- 共通バリデーションJavaScript -->
  <%= javascript_include_tag "reservation-validation", "data-turbo-track": "reload", defer: true %>
  
  <!-- 一般ユーザー用の予約作成機能 -->
  <%= javascript_include_tag "reservation-new", "data-turbo-track": "reload", defer: true %>
<% end %>

<% content_for :head do %>
  <%= stylesheet_link_tag 'reservation-form', media: 'all' %>
<% end %>
