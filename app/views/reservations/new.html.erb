<div class="header">
  <h1>å˜æ—¥ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« - <%= @date.year %>å¹´<%= @date.month %>æœˆ<%= @date.day %>æ—¥</h1>
  <div class="header-buttons">
    <% if current_user&.admin? %>
      <span class="admin-name">ç®¡ç†è€…ã•ã‚“</span>
      <%= link_to "ğŸ‘¥ äºˆç´„è€…ãƒªã‚¹ãƒˆ", list_admin_reservations_path, class: "btn" %>
    <% else %>
      <span class="admin-name"><%= current_user.name.presence || current_user.email %></span>
      <%= link_to "ğŸ“‹ äºˆç´„çŠ¶æ³", reservations_path, class: "btn" %>
    <% end %>
    <%= link_to "ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤º", calendars_reservations_path, class: "btn" %>
    <button class="btn btn-settings" onclick="openSettingsModal()">âš™ï¸ è¨­å®š</button>
  </div>
</div>

<div class="date-navigation">
  <a href="<%= new_reservation_path(date: (@date - 1.day).strftime('%Y-%m-%d')) %>" class="btn">â—€ å‰æ—¥</a>
  <a href="<%= new_reservation_path(date: Date.today.strftime('%Y-%m-%d')) %>" class="btn">ä»Šæ—¥</a>
  <a href="<%= new_reservation_path(date: (@date + 1.day).strftime('%Y-%m-%d')) %>" class="btn">ç¿Œæ—¥ â–¶</a>
  <input type="date" id="datePicker" value="<%= @date.strftime('%Y-%m-%d') %>">
</div>

<div id="status">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
<div id="calendar" data-date="<%= @date.strftime('%Y-%m-%d') %>"></div>

<!-- äºˆç´„è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="reservationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>äºˆç´„è©³ç´°</h2>
      <button class="close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="modalBody"></div>
  </div>
</div>

<!-- äºˆç´„ä½œæˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="createReservationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>äºˆç´„ä½œæˆ</h2>
      <button class="close" onclick="closeCreateModal()">&times;</button>
    </div>
    <div class="modal-body" id="createModalBody">
      <% if @reservation && @reservation.errors.any? %>
        <div class="error-messages" style="background-color: #f8d7da; color: #721c24; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
          <h3 style="margin-top: 0;">ä»¥ä¸‹ã®ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ:</h3>
          <ul style="margin: 0; padding-left: 20px;">
            <% @reservation.errors.full_messages.each do |message| %>
              <li><%= message %></li>
            <% end %>
          </ul>
        </div>
      <% end %>
      
      <%= form_with model: (@reservation || Reservation.new), url: reservations_path, method: :post, local: true, id: "reservationForm" do |f| %>
        <%= f.hidden_field :start_time, id: "reservation_start_time" %>
        <%= f.hidden_field :end_time, id: "reservation_end_time" %>
        <%= hidden_field_tag :date, @date.strftime('%Y-%m-%d') %>
        <%= hidden_field_tag :return_to, 'new' %>
        
        <div class="form-group">
          <label>äºˆç´„æ—¥</label>
          <p id="reservation_date_display" style="font-size: 16px; font-weight: bold; color: #007bff; padding: 10px; background-color: #e7f3ff; border-radius: 5px; margin: 0 0 15px 0;"><%= @date.year %>å¹´<%= @date.month %>æœˆ<%= @date.day %>æ—¥</p>
        </div>
        
        <div class="form-group">
          <label>é–‹å§‹æ™‚é–“</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="start_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% (9..17).each do |hour| %>
                <option value="<%= hour %>" <%= 'selected' if hour == 9 %>><%= hour %>æ™‚</option>
              <% end %>
            </select>
            <select id="start_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                <option value="<%= minute %>" <%= 'selected' if minute == 0 %>><%= minute %>åˆ†</option>
              <% end %>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>çµ‚äº†æ™‚é–“</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <select id="end_hour_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% (9..18).each do |hour| %>
                <option value="<%= hour %>" <%= 'selected' if hour == 10 %>><%= hour %>æ™‚</option>
              <% end %>
            </select>
            <select id="end_minute_input" class="form-control" style="width: auto; min-width: 80px;" required>
              <% [0, 10, 20, 30, 40, 50].each do |minute| %>
                <option value="<%= minute %>" <%= 'selected' if minute == 0 %>><%= minute %>åˆ†</option>
              <% end %>
            </select>
          </div>
        </div>
        
        <%= f.hidden_field :customer_name, value: (@reservation&.customer_name || current_user&.name || current_user&.email&.split('@')&.first || "") %>
        <%= f.hidden_field :customer_email, value: (@reservation&.customer_email || current_user&.email || "") %>
        <%= f.hidden_field :customer_phone, value: (@reservation&.customer_phone || "") %>
        
        <div class="form-group">
          <%= f.label :notes, "å‚™è€ƒ" %>
          <%= f.text_area :notes, rows: 3, class: "form-control", value: (@reservation&.notes || "") %>
        </div>
        
        <div class="form-actions">
          <%= f.submit "äºˆç´„ã‚’ç¢ºå®š", class: "btn btn-primary" %>
          <button type="button" class="btn btn-secondary" onclick="closeCreateModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      <% end %>
    </div>
  </div>
</div>

<!-- è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="settingsModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>è¨­å®š</h2>
      <button class="close" onclick="closeSettingsModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="settings-content">
        <% if current_user&.admin? %>
          <%= link_to "æƒ…å ±å¤‰æ›´", edit_admin_registration_path, class: "btn btn-edit" %>
        <% else %>
          <%= link_to "æƒ…å ±å¤‰æ›´", edit_user_registration_path, class: "btn btn-edit" %>
        <% end %>
        <p>ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã§ã™</p>
        <%= button_to "ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ", destroy_user_session_path, method: :delete, class: "btn btn-logout", form: { data: { turbo: false } } %>
      </div>
    </div>
  </div>
</div>

<%= javascript_include_tag "index-schedule", "data-turbo-track": "reload", defer: true %>

<script>
  <%= File.read(Rails.root.join('app/javascript/index-schedule.js')).html_safe %>
  
  // ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®äºˆç´„ä½œæˆæ©Ÿèƒ½ã‚’è¿½åŠ 
  <% unless current_user&.admin? %>
  (function() {
    // å…ƒã®handleSlotSelectionã‚’ä¿å­˜
    const originalHandleSlotSelection = window.handleSlotSelection;
    
    // æ–°ã—ã„handleSlotSelectionã‚’å®šç¾©
    window.handleSlotSelection = function(info, calendar) {
      const start = new Date(info.startStr);
      const end = new Date(info.endStr);
      
      // ç©ºãæ ã‚’ç¢ºèª
      const dateStr = start.toISOString().split('T')[0];
      const url = '/reservations/available_slots?date=' + dateStr;
      
      fetch(url)
        .then(function(response) {
          if (!response.ok) throw new Error('HTTP ' + response.status);
          return response.json();
        })
        .then(function(slots) {
          const selectedSlot = slots.find(function(slot) {
            return slot.start === start.toISOString() && slot.end === end.toISOString();
          });
          
          if (selectedSlot && selectedSlot.available && selectedSlot.available_count > 0) {
            openReservationForm(start, end);
          } else {
            alert('ã“ã®æ™‚é–“å¸¯ã¯æ—¢ã«æº€å“¡ã§ã™ã€‚åˆ¥ã®æ™‚é–“å¸¯ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
          }
          calendar.unselect();
        })
        .catch(function(error) {
          console.error('Error checking available slots:', error);
          alert('ç©ºãæ ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
          calendar.unselect();
        });
    };
    
    function openReservationForm(start, end) {
      const startTimeInput = document.getElementById('reservation_start_time');
      const endTimeInput = document.getElementById('reservation_end_time');
      const startHourPicker = document.getElementById('start_hour_input');
      const startMinutePicker = document.getElementById('start_minute_input');
      const endHourPicker = document.getElementById('end_hour_input');
      const endMinutePicker = document.getElementById('end_minute_input');
      const dateDisplay = document.getElementById('reservation_date_display');
      
      if (startTimeInput && endTimeInput && startHourPicker && startMinutePicker && endHourPicker && endMinutePicker && dateDisplay) {
        // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ISOå½¢å¼ã§è¨­å®š
        startTimeInput.value = start.toISOString();
        endTimeInput.value = end.toISOString();
        
        // æ™‚é–“ãƒ”ãƒƒã‚«ãƒ¼ã«å€¤ã‚’è¨­å®šï¼ˆ10åˆ†åˆ»ã¿ã«ä¸¸ã‚ã‚‹ï¼‰
        const startHour = start.getHours();
        const startMinute = Math.round(start.getMinutes() / 10) * 10;
        const endHour = end.getHours();
        const endMinute = Math.round(end.getMinutes() / 10) * 10;
        
        // selectè¦ç´ ã«å€¤ã‚’è¨­å®š
        if (startHourPicker.querySelector(`option[value="${startHour}"]`)) {
          startHourPicker.value = String(startHour);
        }
        if (startMinutePicker.querySelector(`option[value="${startMinute}"]`)) {
          startMinutePicker.value = String(startMinute);
        }
        if (endHourPicker.querySelector(`option[value="${endHour}"]`)) {
          endHourPicker.value = String(endHour);
        }
        if (endMinutePicker.querySelector(`option[value="${endMinute}"]`)) {
          endMinutePicker.value = String(endMinute);
        }
        
        // æ—¥ä»˜è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆæ—¢ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ãã®ã¾ã¾ï¼‰
        if (!dateDisplay.textContent) {
          const year = start.getFullYear();
          const month = String(start.getMonth() + 1).padStart(2, '0');
          const day = String(start.getDate()).padStart(2, '0');
          dateDisplay.textContent = year + 'å¹´' + month + 'æœˆ' + day + 'æ—¥';
        }
        
        document.getElementById('createReservationModal').style.display = 'block';
      }
    }
    
    // æ™‚é–“ãƒ”ãƒƒã‚«ãƒ¼ã®å¤‰æ›´æ™‚ã«hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
    function updateHiddenTimeFields() {
      const startHourPicker = document.getElementById('start_hour_input');
      const startMinutePicker = document.getElementById('start_minute_input');
      const endHourPicker = document.getElementById('end_hour_input');
      const endMinutePicker = document.getElementById('end_minute_input');
      const startTimeInput = document.getElementById('reservation_start_time');
      const endTimeInput = document.getElementById('reservation_end_time');
      const dateDisplay = document.getElementById('reservation_date_display');
      
      if (!startHourPicker || !startMinutePicker || !endHourPicker || !endMinutePicker || !startTimeInput || !endTimeInput) {
        console.error('å¿…è¦ãªè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
      }
      
      // æ—¥ä»˜ã‚’å–å¾—ï¼ˆdateDisplayã‹ã‚‰ã€ã¾ãŸã¯ç¾åœ¨ã®æ—¥ä»˜ï¼‰
      let year, month, day;
      
      if (dateDisplay && dateDisplay.textContent) {
        const dateText = dateDisplay.textContent;
        const dateMatch = dateText.match(/(\d{4})å¹´(\d{1,2})æœˆ(\d{1,2})æ—¥/);
        
        if (dateMatch) {
          year = parseInt(dateMatch[1]);
          month = parseInt(dateMatch[2]) - 1; // æœˆã¯0ã‹ã‚‰å§‹ã¾ã‚‹
          day = parseInt(dateMatch[3]);
        }
      }
      
      // dateDisplayã‹ã‚‰å–å¾—ã§ããªã„å ´åˆã¯ã€ç¾åœ¨ã®æ—¥ä»˜ã‚’ä½¿ç”¨
      if (!year || !month || !day) {
        const now = new Date();
        year = now.getFullYear();
        month = now.getMonth();
        day = now.getDate();
        console.warn('æ—¥ä»˜è¡¨ç¤ºã‹ã‚‰æ—¥ä»˜ã‚’å–å¾—ã§ããªã‹ã£ãŸãŸã‚ã€ç¾åœ¨ã®æ—¥ä»˜ã‚’ä½¿ç”¨ã—ã¾ã™');
      }
      
      // æ™‚é–“ã¨åˆ†ã‚’å–å¾—
      const startHour = parseInt(startHourPicker.value) || 9;
      const startMinute = parseInt(startMinutePicker.value) || 0;
      const endHour = parseInt(endHourPicker.value) || 10;
      const endMinute = parseInt(endMinutePicker.value) || 0;
      
      // Dateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
      const startTime = new Date(year, month, day, startHour, startMinute, 0);
      const endTime = new Date(year, month, day, endHour, endMinute, 0);
      
      // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ISOå½¢å¼ã§è¨­å®š
      startTimeInput.value = startTime.toISOString();
      endTimeInput.value = endTime.toISOString();
      
      console.log('Hidden fields updated:', {
        start_time: startTimeInput.value,
        end_time: endTimeInput.value
      });
    }
    
    window.closeCreateModal = function() {
      document.getElementById('createReservationModal').style.display = 'none';
    };
    
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    document.addEventListener('DOMContentLoaded', function() {
      const errorMessages = document.querySelector('.error-messages');
      if (errorMessages) {
        document.getElementById('createReservationModal').style.display = 'block';
      }
      
      // æ™‚é–“ãƒ”ãƒƒã‚«ãƒ¼ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
      const startHourPicker = document.getElementById('start_hour_input');
      const startMinutePicker = document.getElementById('start_minute_input');
      const endHourPicker = document.getElementById('end_hour_input');
      const endMinutePicker = document.getElementById('end_minute_input');
      
      // æ™‚é–“é¸æŠæ™‚ã«hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
      if (startHourPicker) {
        startHourPicker.addEventListener('change', updateHiddenTimeFields);
      }
      if (startMinutePicker) {
        startMinutePicker.addEventListener('change', updateHiddenTimeFields);
      }
      if (endHourPicker) {
        endHourPicker.addEventListener('change', updateHiddenTimeFields);
      }
      if (endMinutePicker) {
        endMinutePicker.addEventListener('change', updateHiddenTimeFields);
      }
      
      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‰ã«æœ€çµ‚ç¢ºèª
      const form = document.getElementById('reservationForm');
      if (form) {
        form.addEventListener('submit', function(e) {
          // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ç¢ºå®Ÿã«æ›´æ–°
          updateHiddenTimeFields();
          
          // hiddenãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
          const startTimeInput = document.getElementById('reservation_start_time');
          const endTimeInput = document.getElementById('reservation_end_time');
          
          if (!startTimeInput || !startTimeInput.value) {
            e.preventDefault();
            alert('é–‹å§‹æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
          }
          
          if (!endTimeInput || !endTimeInput.value) {
            e.preventDefault();
            alert('çµ‚äº†æ™‚é–“ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
            return false;
          }
          
          // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³: çµ‚äº†æ™‚é–“ãŒé–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
          const startHourPicker = document.getElementById('start_hour_input');
          const startMinutePicker = document.getElementById('start_minute_input');
          const endHourPicker = document.getElementById('end_hour_input');
          const endMinutePicker = document.getElementById('end_minute_input');
          
          if (startHourPicker && startMinutePicker && endHourPicker && endMinutePicker) {
            const startHour = parseInt(startHourPicker.value);
            const startMinute = parseInt(startMinutePicker.value);
            const endHour = parseInt(endHourPicker.value);
            const endMinute = parseInt(endMinutePicker.value);
            
            const startTotal = startHour * 60 + startMinute;
            const endTotal = endHour * 60 + endMinute;
            
            if (startTotal >= endTotal) {
              e.preventDefault();
              alert('çµ‚äº†æ™‚é–“ã¯é–‹å§‹æ™‚é–“ã‚ˆã‚Šå¾Œã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚');
              return false;
            }
          }
        });
      }
    });
  })();
  <% end %>
</script>

<style>
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #333;
}

.form-control {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 5px;
  font-size: 14px;
  box-sizing: border-box;
}

.form-actions {
  display: flex;
  gap: 10px;
  justify-content: flex-end;
  margin-top: 20px;
}

.btn-primary {
  background-color: #28a745;
}

.btn-secondary {
  background-color: #6c757d;
}

.btn-secondary:hover {
  background-color: #5a6268;
}

#reservation_date_display {
  font-size: 16px;
  font-weight: bold;
  color: #007bff;
  padding: 10px;
  background-color: #e7f3ff;
  border-radius: 5px;
}
</style>
